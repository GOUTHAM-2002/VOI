{% extends "base_generic.html" %}
{% block content %}
<style>
  /* Voice Input Animation */
  .cylinder-container {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    height: 80px;
  }

  .cylinder {
    width: 30px;
    height: 40px;
    background-color: white;
    border-radius: 9999px;
    animation: wave 1.5s infinite ease-in-out;
  }

  .cylinder:nth-child(1) {
    animation-delay: 0s;
  }

  .cylinder:nth-child(2) {
    animation-delay: 0.3s;
  }

  .cylinder:nth-child(3) {
    animation-delay: 0.6s;
  }

  @keyframes wave {

    0%,
    100% {
      height: 40px;
      opacity: 0.6;
    }

    50% {
      height: 70px;
      opacity: 1;
    }
  }

  /* Image Modal Styles */
  #imageModal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0, 0, 0, 0.9);
    justify-content: center;
    align-items: center;
  }

  #modalImageContainer {
    display: flex;
    justify-content: center;
    align-items: center;
    max-width: 90%;
    max-height: 90%;
  }

  #modalImageContainer img {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
  }
</style>

<body class="bg-gray-900 text-gray-200 p-4 m-0 h-screen overflow-hidden">
  <div class="flex h-full">
    <!-- AI Chat Section -->
    <div class="w-4/5 bg-gray-800 shadow-lg rounded-lg p-4 flex flex-col">
      <h1 class="text-2xl font-bold mb-4">Voice AI</h1>

      <!-- Chat Display -->
      <div id="chat-display" class="flex-1 overflow-y-auto border border-gray-700 rounded-lg p-4 bg-gray-700 space-y-4">
        <div class="text-left">
          <p class="text-gray-300">AI: Hello! How can I help you?</p>
        </div>
      </div>

      <!-- Input Section -->
      <div class="mt-4 flex">
        <!-- <input type="text" id="user-input" placeholder="Type your message..."
          class="flex-1 border border-gray-700 bg-gray-700 text-gray-200 rounded-l-lg p-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
        <button id="send-btn" class="bg-blue-600 text-white px-4 py-2 rounded-r-lg hover:bg-blue-700">
          Send
        </button> -->
      </div>
    </div>

    <!-- Cart Section -->
    <div class="w-1/5 bg-gray-800 shadow-lg rounded-lg p-4 ml-4">
      <h1 class="text-2xl font-bold mb-4">Cart</h1>
      <div id="cart-list" class="space-y-4">
        <!-- Cart items will be dynamically populated here -->
      </div>
    </div>
  </div>

  <!-- Image Modal -->
  <div id="imageModal" class="fixed inset-0 bg-black bg-opacity-90 z-50 hidden">
    <div id="modalImageContainer" class="flex justify-center items-center w-full h-full">
      <img id="modalImage" src="" alt="Product Image" class="max-w-full max-h-full object-contain" />
    </div>
  </div>
</body>



<script>
  document.addEventListener("DOMContentLoaded", function () {


    const cartList = document.getElementById("cart-list");

    // Function to populate cart
    function populateCart(cartItems) {
      // Clear existing cart items
      cartList.innerHTML = "";

      // Check if cart is empty
      if (!cartItems || Object.keys(cartItems).length === 0) {
        const emptyCartMessage = document.createElement("p");
        emptyCartMessage.textContent = "Your cart is empty";
        emptyCartMessage.classList.add("text-gray-500", "text-center");
        cartList.appendChild(emptyCartMessage);
        return;
      }

      // Populate cart with items
      Object.entries(cartItems).forEach(([itemId, itemDetails]) => {
        const cartItemElement = document.createElement("div");
        cartItemElement.classList.add(
          "bg-gray-700",
          "p-3",
          "rounded-lg",
          "flex",
          "justify-between",
          "items-center",
          "mb-2"
        );

        cartItemElement.innerHTML = `
            <div class="flex-1">
                <p class="text-white font-semibold text-sm truncate" title="${itemDetails.Name}">
                    ${itemDetails.Name}
                </p>
                <p class="text-green-400 text-xs">
                    $${itemDetails.Price}
                </p>
            </div>
            <button
                class="remove-item text-red-400 hover:text-red-600 ml-2"
                data-item-id="${itemId}"
            >
                Remove
            </button>
        `;

        // Add remove item functionality
        const removeButton = cartItemElement.querySelector(".remove-item");
        removeButton.addEventListener("click", () => {
          // You might want to add an AJAX call to remove the item from the backend
          cartItemElement.remove();
        });

        cartList.appendChild(cartItemElement);
      });
    }


    function appendMessage(sender, message, images = null) {
      // Ensure chat-display exists
      const chatDisplay = document.getElementById("chat-display");
      if (!chatDisplay) {
        console.error("Chat display element not found");
        return;
      }

      // Create message container
      const messageElement = document.createElement("div");
      messageElement.classList.add("message", `${sender}-message`, "mb-4");

      // Create message content div
      const messageContent = document.createElement("div");
      messageContent.classList.add(
        "bg-gray-600",
        "p-4",
        "rounded-lg",
        "border",
        "border-gray-500",
        "text-white" // Ensure text is visible
      );

      // Clean and set message text
      let cleanMessage = message;
      if (typeof message === "object") {
        cleanMessage = message.reply || JSON.stringify(message);
      }

      // Remove any surrounding quotes or formatting
      cleanMessage = cleanMessage.replace(/^['"]|['"]$/g, "");

      messageContent.textContent = cleanMessage;

      // Handle images if present
      if (images && Object.keys(images).length > 0) {
        const imageContainer = document.createElement("div");
        imageContainer.classList.add(
          "flex",
          "justify-center",
          "space-x-4",
          "mt-4",
          "flex-wrap"
        );

        try {
          Object.entries(images).forEach(([itemKey, itemImages]) => {
            Object.entries(itemImages).forEach(([imageKey, imageUrl]) => {
              const imgWrapper = document.createElement("div");
              imgWrapper.classList.add("w-1/3", "p-2", "cursor-pointer");

              const img = document.createElement("img");
              img.src = imageUrl;
              img.alt = `${itemKey} - ${imageKey}`;
              img.classList.add("w-full", "h-48", "object-cover", "rounded");

              img.addEventListener("click", () => {
                const imageModal = document.getElementById("imageModal");
                const modalImage = document.getElementById("modalImage");
                if (imageModal && modalImage) {
                  modalImage.src = imageUrl;
                  imageModal.classList.remove("hidden");
                  imageModal.classList.add("flex");
                }
              });

              imgWrapper.appendChild(img);
              imageContainer.appendChild(imgWrapper);
            });
          });

          messageContent.appendChild(imageContainer);
        } catch (error) {
          console.error("Error processing images:", error);
        }
      }

      // Append message content to message element
      messageElement.appendChild(messageContent);

      // Append to chat display
      chatDisplay.appendChild(messageElement);

      // Scroll to bottom
      chatDisplay.scrollTop = chatDisplay.scrollHeight;

      // Debug logging
      console.log(
        `Message appended - Sender: ${sender}, Message: ${cleanMessage}`
      );
    }



    function initializeSpeechRecognition() {
      // Check for speech recognition support  
      if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const recognition = new SpeechRecognition();

        // Configuration  
        recognition.lang = 'en-US';
        recognition.interimResults = false;
        recognition.continuous = false; // Changed to false for better control  

        // Speech Recognition Event Handlers  
        recognition.onstart = () => {
          console.log("Speech recognition started");
        };

        recognition.onresult = (event) => {
          // Extract the most recent transcript  
          const transcript = event.results[event.results.length - 1][0].transcript.trim();

          console.log("Recognized speech:", transcript);

          // Send recognized speech to server  
          sendMessage(transcript);
        };

        recognition.onerror = (event) => {
          console.error("Speech recognition error:", event.error);
        };

        recognition.onend = () => {
          console.log("Speech recognition ended");
        };

        // Return the recognition object for external control  
        return recognition;
      } else {
        console.error("Speech Recognition is not supported in this browser.");
        return null;
      }
    }

    function textToVoice(text, lang = 'en-US') {
      return new Promise((resolve, reject) => {
        // Check for speech synthesis support  
        if ('speechSynthesis' in window) {
          // Cancel any ongoing speech  
          window.speechSynthesis.cancel();

          // Create a new utterance  
          const utterance = new SpeechSynthesisUtterance(text);

          // Configure utterance  
          utterance.lang = lang;
          utterance.rate = 1.0;
          utterance.pitch = 1.0;

          // Event handlers  
          utterance.onstart = () => {
            console.log("Text-to-speech started");
          };

          utterance.onend = () => {
            console.log("Text-to-speech ended");
            resolve();
          };

          utterance.onerror = (event) => {
            console.error("Text-to-speech error:", event);
            reject(event);
          };

          // Attempt to get a natural-sounding voice  
          const voices = window.speechSynthesis.getVoices();
          const naturalVoice = voices.find(voice =>
            voice.lang === lang &&
            (voice.name.includes('Natural') || voice.name.includes('Google'))
          );

          if (naturalVoice) {
            utterance.voice = naturalVoice;
          }

          // Speak the text  
          window.speechSynthesis.speak(utterance);
        } else {
          console.error("Text-to-Speech is not supported in this browser.");
          reject(new Error("Text-to-Speech not supported"));
        }
      });
    }

    function sendMessage(message) {
      if (!message) return;

      // Display user message  
      appendMessage("user", message);

      // Send to server  
      fetch("/home/", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": "{{ csrf_token }}",
        },
        body: JSON.stringify({ message: message }),
      })
        .then((response) => response.json())
        .then((data) => {
          // Flexible response handling  
          console.log("Server response:", data);

          // Check for different possible response formats  
          const reply = data.reply || data.message || data.text || "No response received";
          const images = data.images || {};

          // Display bot response with images  
          appendMessage("bot", reply, images);

          // Text to Voice with Promise-based approach  
          return textToVoice(reply);
        })
        .catch((error) => {
          console.error("Error:", error);
          appendMessage(
            "bot",
            "Sorry, I encountered an error. Please try again."
          );
        });
    }

    function initializeVoiceInteraction() {
      // Initialize Speech Recognition  
      const recognition = initializeSpeechRecognition();

      // Add a button or method to start voice recognition  
      const startVoiceRecognitionBtn = document.createElement('button');
      startVoiceRecognitionBtn.textContent = 'Start Voice Input';
      startVoiceRecognitionBtn.classList.add(
        'bg-green-500', 'text-white', 'p-2', 'rounded', 'ml-2'
      );

      // Append to input section  
      const inputSection = document.querySelector('.mt-4.flex');
      inputSection.appendChild(startVoiceRecognitionBtn);

      // Add click event to start voice recognition  
      startVoiceRecognitionBtn.addEventListener('click', () => {
        if (recognition) {
          recognition.start();
        }
      });
    }

    // Initialize voice interaction  
    initializeVoiceInteraction();
  });
</script>
{% endblock %}